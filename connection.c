/*connection*/
#include <stdio.h>
#include <string.h>
#include <unistd.h>
#include <arpa/inet.h>
#include <sys/socket.h>
#include <stdlib.h>
#include <netdb.h>
#include <netinet/in.h>

#include "connection.h"
//#include "daihinmin.h"

#define PROTOCOL_VERSION	20070		//?v???g?R?????@?[?W???????\??????
#define DEFAULT_SERVER		"127.0.0.1"	//?f?t?H???g?ÌƒT?[?o?ÌƒA?h???X ???????Åw??
#define DEFAULT_PORT		42485		//?f?t?H???g?Ìƒ|?[?g?Ô? ?????Åw??
#define DEFAULT_NAME		"newbie"	//?f?t?H???g?ÌƒN???C?A???g?? ???????Åw??

const int g_logging=0;

/* ?Ã“I?Ö??ÌŠÖ??v???g?^?C?v?éŒ¾ */
static int refreshTable(int table_val[8][15]);
static int sendTable(int table_val[8][15]);
static int openSocket(const char ip_addr[], uint16_t portnum_data);
static int sendProfile(const char user[15]);

/*connection???????Ï?*/

//?\?P?b?g?Ö˜A?Ì•Ï????Ã“I?O???[?o???Ï??Æ‚??ÄéŒ¾
static int g_sockfd;
static int g_buf_len;
static struct sockaddr_in g_client_addr;

//?Ú‘??????T?[?o?A?|?[?g???i?[?????Ï?
static char     server_name[256]= DEFAULT_SERVER;
static uint16_t port            = DEFAULT_PORT;
//?T?[?o?É’Ê’m?????N???C?A???g??
static char     user_name[15]   = DEFAULT_NAME;

//?e?[?u???????M?????ñ”‚??J?E???g
static int table_count=0;

//host?ÉÚ‘??? ?Q?[???ÉQ?Á‚??? ?v???[???[?Ô????Ô‚?
int entryToGame(void){
  int my_playernum;  //?v???C???[?Ô????L??????
  //?T?[?o?É‘Î‚??Äƒ\?P?b?g???p?Ó‚??Aconnect????
  if((openSocket(server_name,port))== -1){
    printf("failed to open socket to server[%s:%d].\n",server_name,port);
    exit (1);
  }
  if(g_logging==1){
    printf("connectiong to server was finished successfully[%s:%d].\n",server_name,port);
  }

  sendProfile(user_name);     //?N???C?A???g?Ì????ğ‘—M

  if(g_logging==1){
    printf("send profile .\n");
  }
  //???g?Ìƒv???C???[?Ô????T?[?o???????ç‚¤
  if(read(g_sockfd, &my_playernum, sizeof(my_playernum)) > 0){
    my_playernum=ntohl(my_playernum);
    if(g_logging==1){
      printf("my player number is %d\n",my_playernum);
    }
  }
  else{
    printf("failed to get player number.\n");
    exit (1);
  }

  return my_playernum; //???g?Ìƒv???C???[?Ô????Ô‚??B
}


//?\?P?b?g??close???s?? ???÷‚µ‚??ê‡?? 0 ???Ô‚??B?G???[???????????ê‡?? -1 ???Ô‚?
int closeSocket(){
  return close(g_sockfd);
}

//?V???b?t?????ê‚½?J?[?h???ó‚¯??? ?????Ú‚ÌƒQ?[???????Ô‚?
int startGame(int table[8][15]){
  static int game_count=0;
  //???O???è‚ª?L???È‚??Q?[???Ô????\??
  if(g_logging == 1){
    printf("game number is %d.\n",game_count);
  }
  table_count=0;// ?Q?[???J?n?Æ“????Éƒe?[?u???ÌƒJ?E???g??0?É‚????B
  //?????ÌƒJ?[?h???ó‚¯???
  if(((refreshTable(table)))== -1) {
    printf("failed to get initial cards table for exchange.\n");
    exit(1) ;
  }

  //???O???è‚ª?L???È‚??A?z?z???ê‚½?J?[?h(?Æ‚??????e?[?u??)???\??
  if(g_logging ==1){
    printf("initial cards table is follow.\n");
    //outputTable(table);
  }

  game_count++;

  return game_count;
}

//?J?[?h?ğŠ·??ÌƒJ?[?h?Ì’??o
void sendChangingCards(int cards[8][15]){
  if(sendTable(cards)==-1){
    //???s???????G???[???Í‚??Ä’??~
    printf("sending cards table was failed.\n");
    exit (1);
  }
  else{
    //???÷‚?loggin?t???O?????Á‚Ä‚??????A???b?Z?[?W???f??
    if(g_logging==1){
      printf("sending cards-table was done successfully.\n");
    }
  }
  //loggin?t???O?????Á‚Ä‚??????A?e?[?u???Ì“??e???o??
  if(g_logging == 1){
    //?e?[?u???Ì“??e???o??
    printf("sent card table was......\n");
    //outputTable(cards);
  }
}

//?J?[?h???ó‚¯??? ?????Ìƒ^?[???Å‚?????1???Ô‚?
int receiveCards(int cards[8][15]){
  //?J?[?h???ó‚¯???
  if(((refreshTable(cards)))== -1 ){
    //???s?????ê‡?ÌƒG???[????
    printf("failed to get my cards table.\n");
    exit (1);
  }
  else{
    //?????? logging?t???O?É‰??????O?Ì•\??
    if(g_logging == 1){
      printf("recieved my cards table.\n");
      printf("  table count=%d\n",table_count);
      //outputTable(cards);
    }
  }
  //getState(cards);   //???Ì??Ô‚Ì“Ç‚İo??
  return cards[5][2];
}

//?J?[?h?????o???ó—‚??ê‚½???Û‚????Ô‚?
int sendCards(int cards[8][15]){
  int accept_flag; //???o?????J?[?h???ó—‚??ê‚½???ğ”»•Ê‚????Ï?
  //?J?[?h?ğ‘—M????
  if(g_logging==1){
    printf("send card table was following.\n");
    //outputTable(cards);
  }

  if((sendTable(cards)) == -1 ){ //?J?[?h?ğ‘—M?? ???s???Íƒ??b?Z?[?W???\??
    printf("failed to send card sending table. \n");
    exit(1);
  }

  //accept_flag???T?[?o?????ó‚¯???
  if((read(g_sockfd, &accept_flag, sizeof(accept_flag))) < 0 ){
    printf("failed to get accept sign.\n");
    exit(1);
  }
  else{
     if(g_logging==1){
       printf("accept_flag=%d\n",(int)ntohl(accept_flag));
     }
  }
  return ntohl(accept_flag);
}

//???E???h?ÌÅŒ??ÉƒQ?[?????I?Á‚????? ?T?[?o?????ó‚¯‚Æ‚? ???Ì’l???Ô‚??B
int beGameEnd(void){
  int one_gameend_flag;
  //?Q?[???I???Ìƒt???O???ó‚¯???
  if ((read(g_sockfd, &one_gameend_flag, sizeof(one_gameend_flag))) < 0 ){
    //???M???s?? ???b?Z?[?W???\???????~
    printf("failed to check if the game was finished.\n");
    exit(1);
  }else{
    //???M?????? ?l?Ìƒo?C?g?I?[?_?[?ğ’¼‚?
    one_gameend_flag=ntohl( one_gameend_flag);
  }
  return one_gameend_flag;
}

void lookField(int cards[8][15]){
  if(((refreshTable(cards)))== -1 ){
    //???s?????ê‡?ÌƒG???[????
    printf("failed to get result table.\n");
    exit (1);
  }else{
    //???÷ƒ??O???\??
    if(g_logging == 1){
      printf("received result table.\n");
      //outputTable(cards);
      printf("end bacards\n");
    }
  }
  //getField(cards); //???Éo?Ä‚????J?[?h?Ì??????Ç‚İo??
}

void checkArg(int argc,char* argv[]){
  /*
    ?n???ê‚½?R?}???h???C???????^?????ê‚½?????Ì????????Í‚??A?K?v?É‰?????
    ?T?[?o?A?h???X?A?|?[?g?Ô??A?N???C?A???g?????ÏX?????B
  */
  const char Option[]="[-h server_adress] [-p port] [-n user_name]";
  int        arg_count=1;

  while(arg_count<argc){
    if( strcmp(argv[arg_count],"--help")==0){
      printf("usage : %s %s\n",argv[0],Option);
      exit(0);
    }else if (strcmp(argv[arg_count],"-h")==0){
      arg_count++;
      if (arg_count<argc){
	strcpy(server_name,argv[arg_count]);
      }else{
	printf("%s -h hostname\n",argv[0]);
	exit(1);
      }
    }else if ((strcmp(argv[arg_count],"-p"))==0){
      arg_count++;
      if (arg_count<argc){
	port = (uint16_t)atoi(argv[arg_count]);
      }else{
	printf("%s -p port\n",argv[0]);
	exit(1);
      }
    }else if ((strcmp(argv[arg_count],"-n"))==0){
      arg_count++;
      if (arg_count<argc){
	strcpy(user_name ,argv[arg_count]);
      }else{
	printf("%s -n user_name\n",argv[0]);
	exit(1);
      }
    }else{
      printf("%s : unknown option : %s \n",argv[0],argv[arg_count]);
      printf("usage : %s %s\n",argv[0],Option);
      //exit(1);
    }
    arg_count++;
  }
}

//?T?[?o?????e?[?u?????????ó‚¯????A?????È‚?0???s?È‚?-1???Ô‚?
static int refreshTable(int table_val[8][15]){
  uint32_t net_table[8][15];
  if ((g_buf_len = read(g_sockfd,net_table, 480)) > 0){
    int i,j;
    //?S?Ä‚Ìƒe?[?u???Ì—v?f???l?b?g???[?N?I?[?_?[?????z?X?g?I?[?_?[?É•ÏŠ?
    for(i=0;i<8;i++)
      for(j=0;j<15;j++)
	table_val[i][j]=ntohl(net_table[i][j]);
    table_count++;
    return 0;
  }
  else{
    return(-1);
  }
}

//?T?[?o?Éƒe?[?u???????ğ“Š‚????Ö??B?????È‚?0?@???s??-1???Ô‚?
static int sendTable(int table_val[8][15]){
  uint32_t net_table[8][15];
  int i,j;
  //?S?Ä‚Ìƒe?[?u???Ì—v?f???z?X?g?I?[?_?[?????l?b?g???[?N?I?[?_?[?É•ÏŠ?
  for(i=0;i<8;i++)
    for(j=0;j<15;j++)
      net_table[i][j]=htonl(table_val[i][j]);
  //?ÏŠ??????e?[?u???ğ‘—M
  if((g_buf_len = write(g_sockfd, net_table, 480))> 0){
    return (0);
  }
  else{
    return (-1);
  }
}

//?\?P?b?g?Ìİ’??E?Ú‘????s?? ??????0?A???s??-1???Ô‚?
static int openSocket(const char addr[], uint16_t port_num){
  //?\?P?b?g?Ì???
  if ((g_sockfd = socket(PF_INET, SOCK_STREAM, 0)) < 0){
    return(-1);
  }

  /* ?|?[?g?ÆƒA?h???X?Ìİ’? */
  bzero((char*)&g_client_addr,sizeof(g_client_addr));
  g_client_addr.sin_family = PF_INET;
  g_client_addr.sin_port = htons(port_num);
  g_client_addr.sin_addr.s_addr = inet_addr(addr);

  //IP?A?h???X?Åw?è‚³???Ä‚??È‚??Æ‚??A?z?X?g???Ì‰ğŒˆ‚ğ‚İ‚?
  if (g_client_addr.sin_addr.s_addr == 0xffffffff) {
    struct hostent *host;
    host = gethostbyname(addr);
    if (host == NULL) {
      printf("failed to gethostbyname() : %s.\n",addr);
      return -1;//?z?X?g???ğŒˆ‚É??s?????Æ‚??A-1???Ô‚?
    }
    g_client_addr.sin_addr.s_addr=
      *(unsigned int *)host->h_addr_list[0];
  }

  /* ?T?[?o?ÉƒR?l?N?g???? */
  if (connect(g_sockfd,(struct sockaddr *)&g_client_addr, sizeof(g_client_addr)) == 0){
    return 0;
  }
  return -1;
}

//?N???C?A???g?Ì????ğ‘—M
static int sendProfile(const char user[15]){
  int profile[8][15];
  int i;

  bzero((char *) &profile, sizeof(profile));        //?e?[?u????0?Å‚??ß‚?
  profile[0][0]=PROTOCOL_VERSION;                   //2007?N?x?Å‚??éŒ¾
  for(i=0;i<15;i++) profile[1][i]=(int)user[i];     //?????Ò–????e?[?u???ÉŠi?[

  //???M
  if(sendTable(profile)==-1){                       //???s???????G???[???o?Í‚????~
    printf("sending profile table was failed.\n");
    exit (1);
  }

  //???÷‚?logging?t???O?????Á‚Ä‚??????A???b?Z?[?W?Æƒe?[?u???Ì“??e???o?Í‚???
  if(g_logging==1){
    printf("sending profile was done successfully.\n");
    printf("sent profile table was......\n");
    //outputTable(profile);
  }
  return 0;
}
